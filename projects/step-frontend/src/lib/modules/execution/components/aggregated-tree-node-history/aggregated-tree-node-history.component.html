<div class="container">
  @if (historyArtefactsData$ | async; as historyData) {
    <div class="previous-executions-container">
      @for (executionItem of historyData.previousExecutions; track executionItem?.execution?.id! || $index) {
        @if (executionItem === null) {
          <div
            class="history-item-container connect-line"
            matTooltipPosition="above"
            matTooltip="No execution"
            [class.arrow]="$last"
          >
            <div class="empty-piechart"></div>
          </div>
        } @else {
          <ng-container
            *ngTemplateOutlet="historyItem; context: { item: executionItem, last: $last, isCurrentExecution: false }"
          />
        }
      }
    </div>
    <ng-container
      *ngTemplateOutlet="
        historyItem;
        context: { item: historyData.currentExecution, last: false, isCurrentExecution: true }
      "
    />
  }
</div>

<ng-template #historyItem let-item="item" let-last="last" let-isCurrentExecution="isCurrentExecution">
  <step-popover [noPadding]="true">
    <div
      class="history-item-container"
      [class.highlight]="isCurrentExecution"
      [class.connect-line]="!isCurrentExecution"
      [class.arrow]="last && !isCurrentExecution"
    >
      <step-aggregated-tree-node-statuses-piechart [slices]="item.statusSlices" [highlight]="isCurrentExecution" />

      <div class="timestamp">
        <div>{{ item.execution.startTime! | date: 'dd.MM' }}</div>
        <div>{{ item.execution.startTime! | date: 'HH:mm' }}</div>
      </div>
    </div>

    <step-popover-content>
      <step-status-distribution-tooltip
        [statuses]="item.statusesCount"
        [linkLabel]="isCurrentExecution ? 'Current execution' : 'See execution'"
        [link]="isCurrentExecution ? '' : '/executions/' + item.execution.id!"
        [timestamp]="item.execution.startTime!"
      />
    </step-popover-content>
  </step-popover>
</ng-template>
