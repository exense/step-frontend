<section>
  <step-scheduler-report-view-header />
  <div class="row">
    <div class="piechart-container">
      @if (_state.summaryData$ | async; as summary) {
        <step-alt-report-node-summary title="Summary: Executions" [summary]="summary" [disableChartItemClick]="true" />
      } @else {
        <step-alt-report-widget title="Summary: Executions">
          <step-alt-report-widget-content class="widget-content">
            <ng-container *ngTemplateOutlet="loadingSpinner" />
          </step-alt-report-widget-content>
        </step-alt-report-widget>
      }
    </div>

    <step-alt-report-widget class="flex-grow-1" title="Executions statuses over time">
      <step-alt-report-widget-content class="widget-content">
        @if (_state.executionsChartSettings$ | async; as executionsChartSettings) {
          <step-timeseries-chart
            [settings]="executionsChartSettings"
            (zoomChange)="handleMainChartZoom($event)"
            [height]="340"
          >
            <ng-template tooltipContent let-data let-reposition="reposition">
              <step-executions-chart-tooltip [scaleKey]="'z'" (reposition)="reposition()" [data]="data" />
            </ng-template>
          </step-timeseries-chart>
        } @else {
          <ng-container *ngTemplateOutlet="loadingSpinner" />
        }
      </step-alt-report-widget-content>
    </step-alt-report-widget>
  </div>
  <div class="row">
    <div class="flex-grow-1">
      <step-cross-execution-heatmap [defaultDateRange]="luxonDateRange()" #heatmap />
    </div>
  </div>
  <div class="row">
    <step-alt-report-widget class="flex-grow-1" [title]="byExecutionChartTitle()">
      <step-alt-report-widget-content class="widget-content">
        <div class="chart-actions-container">
          <step-tabs
            [tabs]="primaryChartTypes"
            [shrink]="true"
            [activeTabId]="reportNodesChartType()"
            (activeTabIdChange)="switchReportNodesChart($event)"
          />
        </div>
        @if (reportNodesChartType() === 'keywords') {
          @if (_state.keywordsChartSettings$ | async; as settings) {
            <step-timeseries-chart [settings]="settings.chartSettings" [height]="350">
              <ng-template tooltipContent let-data>
                <div class="ts-tooltip">
                  <div
                    class="link-item"
                    (click)="jumpToExecution(settings.lastExecutions[data.idx!].id!)"
                    title="See Execution"
                  >
                    <span>{{ settings.lastExecutions[data.idx!].description || 'Unnamed' }}</span>
                    <span class="link-icon"></span>
                  </div>
                </div>
              </ng-template>
            </step-timeseries-chart>
          }
        } @else if (reportNodesChartType() === 'testcases') {
          @if (_state.testCasesChartSettings$ | async; as testCasesData) {
            <step-timeseries-chart [settings]="testCasesData.chart!" [height]="350">
              <ng-template tooltipContent let-data>
                <div class="ts-tooltip">
                  <div
                    class="link-item"
                    (click)="jumpToExecution(testCasesData.lastExecutions[data.idx!].id!)"
                    title="See Execution"
                  >
                    <span>{{ testCasesData.lastExecutions[data.idx!].description || 'Unnamed' }}</span>
                    <span class="link-icon"></span>
                  </div>
                </div>
              </ng-template>
            </step-timeseries-chart>
          }
        } @else {
          <ng-container *ngTemplateOutlet="loadingSpinner" />
        }
      </step-alt-report-widget-content>
    </step-alt-report-widget>
  </div>
  <div class="row">
    <step-alt-report-widget class="flex-grow-1" title="Errors">
      <step-alt-report-widget-content class="widget-content">
        <step-alt-execution-errors
          [dataSource]="_state.errorsDataSource"
          [statusFilterItems]="availableErrorTypes()"
          [showActions]="false"
        />
      </step-alt-report-widget-content>
    </step-alt-report-widget>
  </div>
  <div class="row">
    <step-alt-report-widget class="flex-grow-1" title="Executions">
      <step-alt-report-widget-content class="widget-content">
        @if (luxonDateRange(); as dateRange) {
          <step-cross-execution-executions-table
            [defaultDateRange]="dateRange!"
            #executionList
            [hiddenFilters]="_state.executionsTableFilter"
          />
        }
      </step-alt-report-widget-content>
    </step-alt-report-widget>
  </div>
</section>

<ng-template #loadingSpinner>
  <div class="spinner-container">
    <mat-spinner [diameter]="40" />
  </div>
</ng-template>
