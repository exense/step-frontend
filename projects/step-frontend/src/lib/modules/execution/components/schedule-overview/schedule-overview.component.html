<section class="header">
  @if (selectedTask; as task) {
    <div class="title">
      <entity-icon entityName="tasks" [entity]="task"></entity-icon>
      <h3>{{ task.attributes?.['name'] }}</h3>
      @if (lastExecution) {
        <div class="last-execution-container">
          <span>Last execution:</span>
          <step-alt-execution-time [execution]="lastExecution" />
          <step-status [status]="lastExecution!.result" />
        </div>
      }
    </div>
  }
  <div class="range-picker">
    <step-form-field>
      <step-prefix class="icon-prefix">
        <step-icon name="calendar" (click)="picker.open()" />
      </step-prefix>
      <input
        type="text"
        placeholder="From - To"
        [formControl]="dateRangeCtrl"
        [stepDateRangePicker]="picker"
        [showRelativeTime]="true"
        (relativeOptionChange)="updateRelativeTime($event)"
        [matTooltip]="rangePicker.formattedValue()"
        matTooltipPosition="before"
        #rangePicker="DateRangePicker"
      />
    </step-form-field>
    <step-date-picker [relativeRangeOptions]="RELATIVE_TIME_RANGES" #picker></step-date-picker>
  </div>
</section>
<section>
  <div class="row">
    <div class="piechart-container">
      @if (summary) {
        <step-alt-report-node-summary title="Summary: Executions" [summary]="summary" />
      }
    </div>
    <step-alt-report-widget class="flex-grow-1">
      <step-alt-report-widget-content>
        @if (executionsChartSettings) {
          <step-timeseries-chart [settings]="executionsChartSettings">
            <ng-template tooltipContent let-data>
              <step-executions-chart-tooltip [data]="data" />
            </ng-template>
          </step-timeseries-chart>
        }
      </step-alt-report-widget-content>
    </step-alt-report-widget>
  </div>
  <div class="row">
    <step-alt-report-widget class="flex-grow-1">
      <step-alt-report-widget-content>
        @if (keywordsChartSettings) {
          <step-timeseries-chart [settings]="keywordsChartSettings">
            <ng-template tooltipContent let-data>
              <div class="container">
                <div
                  class="link-item"
                  (click)="jumpToExecution(lastKeywordsExecutions[data.idx!].id!)"
                  title="See Execution"
                >
                  <span>{{ lastKeywordsExecutions[data.idx!].description || 'Unnamed' }}</span>
                  <span class="link-icon"></span>
                </div>
              </div>
            </ng-template>
          </step-timeseries-chart>
        }
      </step-alt-report-widget-content>
    </step-alt-report-widget>
  </div>
  @if (testCasesChartSettings) {
    <div class="row">
      <step-alt-report-widget class="flex-grow-1">
        <step-alt-report-widget-content>
          <step-timeseries-chart [settings]="testCasesChartSettings">
            <ng-template tooltipContent let-data>
              <div class="container">
                <div
                  class="link-item"
                  (click)="jumpToExecution(lastKeywordsExecutions[data.idx!].id!)"
                  title="See Execution"
                >
                  <span>{{ lastKeywordsExecutions[data.idx!].description || 'Unnamed' }}</span>
                  <span class="link-icon"></span>
                </div>
              </div>
            </ng-template>
          </step-timeseries-chart>
        </step-alt-report-widget-content>
      </step-alt-report-widget>
    </div>
  }
</section>
<div class="row">
  <step-alt-report-widget class="flex-grow-1" title="Errors">
    <step-alt-report-widget-content style="height: 100%">
      <div class="widget">
        @if (errorsDataSource) {
          <step-table
            #table
            [dataSource]="errorsDataSource!"
            matSort
            noResultsPlaceholder="No errors"
            matSortActive="count"
            matSortDirection="desc"
          >
            <ng-container matColumnDef="errorMessage" stepSearchCol>
              <th mat-header-cell mat-sort-header *matHeaderCellDef>Error Message</th>
              <td mat-cell *matCellDef="let element">
                <span class="error-name">
                  <span>{{ element.errorMessage }}</span>
                  <step-icon
                    class="icon"
                    matTooltip="See execution"
                    name="external-link"
                    [matMenuTriggerFor]="menu"
                  ></step-icon>
                </span>

                <mat-menu #menu="matMenu" class="wide-menu">
                  <step-error-details-menu
                    [executionIds]="element.executionIds"
                    [truncated]="element.executionIdsTruncated"
                  ></step-error-details-menu>
                </mat-menu>
              </td>
            </ng-container>
            <ng-container matColumnDef="errorCode" stepSearchCol>
              <th mat-header-cell mat-sort-header *matHeaderCellDef>Error Code</th>
              <td mat-cell *matCellDef="let element">
                {{ element.errorCode }}
              </td>
            </ng-container>
            <ng-container matColumnDef="count">
              <th mat-header-cell mat-sort-header *matHeaderCellDef>Count</th>
              <td mat-cell *matCellDef="let element">
                {{ element.count }}
              </td>
            </ng-container>
            <ng-container matColumnDef="types" stepSearchCol>
              <th mat-header-cell mat-sort-header *matHeaderCellDef>Type</th>
              <td mat-cell *matCellDef="let element">
                <div class="types-column">
                  @for (type of element.types; track type) {
                    <step-status [status]="type" />
                  }
                </div>
              </td>
            </ng-container>
            <ng-container matColumnDef="percentage">
              <th mat-header-cell mat-sort-header *matHeaderCellDef>Percentage</th>
              <td mat-cell *matCellDef="let element">{{ element.percentage }}%</td>
            </ng-container>
          </step-table>
        }
      </div>
    </step-alt-report-widget-content>
  </step-alt-report-widget>
</div>
