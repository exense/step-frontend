<section class="header" [class.small-screen]="!!(_isSmallScreen$ | async)">
  <div class="title">
    <h3 data-step-testid="task-or-plan-title">
      @if (_state.task(); as task) {
        <entity-icon entityName="tasks" [entity]="task"></entity-icon>
      }
      @if (_state.plan(); as plan) {
        <entity-icon entityName="plans" [entity]="plan"></entity-icon>
      }

      <div>{{ viewTitle() }}</div>
      @if ((_state.lastExecution$ | async)?.execution; as lastExecution) {
        @if (_state.plan() !== null) {
          <a
            class="plan-link"
            [routerLink]="['/plans/editor', lastExecution.planId]"
            matTooltip="Navigate to plan"
            matTooltipPosition="right"
          >
            <step-icon name="external-link" />
          </a>
        }
      }
    </h3>
  </div>
  <div class="sub-title">
    @if (_state.lastExecution$ | async; as lastExecutionResponse) {
      @if (lastExecutionResponse.execution; as lastExecution) {
        <step-alt-execution-time
          popoverTitle="Last execution"
          [startTime]="lastExecution.startTime"
          [endTime]="lastExecution.endTime"
          [isRunning]="lastExecution.status === 'RUNNING'"
          [status]="lastExecution?.result"
        >
          <step-alt-execution-time-popover-title>
            <div style="margin-bottom: 1rem">Last Execution</div>
          </step-alt-execution-time-popover-title>
        </step-alt-execution-time>
      } @else {
        <div>No execution</div>
      }
    }
    @if (_state.task(); as task) {
      <span class="cron-label" matTooltip="Cron expression">
        {{ task.cronExpression }}
      </span>
    }
  </div>
  <div class="controls">
    <step-autorefresh-toggle
      [interval]="_state.refreshInterval()"
      (refresh)="triggerRefresh()"
      (intervalChange)="handleRefreshIntervalChange($event)"
    />
    @if (_state.activeTimeRangeSelection()) {
      <div class="range-picker">
        <step-time-range-picker
          (selectionChange)="handleTimeRangeChange($event)"
          [selectOptions]="timeRangeOptions"
          [activeSelection]="_state.activeTimeRangeSelection()!"
          [activeTimeRange]="(_state.timeRange$ | async) || undefined"
        />
      </div>
    }
  </div>
</section>

<section class="main">
  <step-tabs [tabs]="tabs" [userRouteLinks]="true" />
  <router-outlet />
</section>
