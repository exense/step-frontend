<mat-card>
  <mat-card-header class="header-with-button">
    <mat-card-title>User</mat-card-title>
    <button type="button" mat-flat-button color="primary" (click)="changePwd()" [disabled]="!canChangePassword">
      Change password
    </button>
  </mat-card-header>
  <mat-card-content class="user">
    <section>
      <step-avatar-editor [disabled]="!canEdit" [colorPicker]="colorPicker" />
      <step-color-picker #colorPicker />
    </section>
    @if (_userState.user$ | async; as user) {
      <section>
        <step-form-field alignLabelAddon="near">
          <step-label>Username</step-label>
          <step-label-addon>{{ user.username }}</step-label-addon>
        </step-form-field>
        <step-form-field alignLabelAddon="near">
          <step-label>Role</step-label>
          <step-label-addon>{{ user.role }}</step-label-addon>
        </step-form-field>
      </section>
    }
  </mat-card-content>
</mat-card>
<mat-card>
  <mat-card-header class="header-with-button">
    <mat-card-title class="title-with-hint">
      <div>Api key</div>
      <step-description-hint
        description="API keys can be used for authentication with the step API (<a href='https://step.exense.ch/knowledgebase/userdocs/userpreferences/#user-credentials-and-api-keys' target='_blank'>knowledgebase</a>)"
      />
    </mat-card-title>
    <button
      type="button"
      mat-flat-button
      color="primary"
      (click)="invokeShowGenerateApiKeyDialog()"
      [disabled]="!canEdit"
    >
      Generate new Key
    </button>
  </mat-card-header>
  <mat-card-content class="role">
    <section>
      <step-table [dataSource]="tokensSource">
        <ng-container matColumnDef="label">
          <th mat-header-cell *matHeaderCellDef>Label</th>
          <td mat-cell *matCellDef="let element">
            {{ element.label || element.id }}
          </td>
        </ng-container>
        <ng-container matColumnDef="created">
          <th mat-header-cell *matHeaderCellDef>Created</th>
          <td mat-cell *matCellDef="let element">
            {{ element.creationTime | date }}
          </td>
        </ng-container>
        <ng-container matColumnDef="expired">
          <th mat-header-cell *matHeaderCellDef>Expired</th>
          <td mat-cell *matCellDef="let element">
            {{ element.expiryTime | date }}
          </td>
        </ng-container>
        <ng-container matColumnDef="actions">
          <th class="actions" mat-header-cell *matHeaderCellDef></th>
          <td mat-cell *matCellDef="let element">
            <button mat-icon-button matTooltip="Revoke token" (click)="revokeAPIToken(element.id)">
              <step-icon name="trash-2"></step-icon>
            </button>
          </td>
        </ng-container>
      </step-table>
    </section>
  </mat-card-content>
</mat-card>
<mat-card>
  <mat-card-header>
    <mat-card-title class="title-with-hint">
      <div>Preferences</div>
      <step-description-hint
        description="Add key/value pairs of custom preferences (<a href='https://step.exense.ch/knowledgebase/userdocs/userpreferences/#preferences' target='_blank'>knowledgebase</a>)"
      />
    </mat-card-title>
  </mat-card-header>
  <mat-card-content>
    <step-table [dataSource]="_userState.preferences$">
      <section class="header" *stepAdditionalHeader="'add-preference'">
        <button type="button" mat-mini-fab color="primary" (click)="_userState.addPreference()">
          <step-icon name="plus" />
        </button>
      </section>
      <ng-container matColumnDef="key">
        <th mat-header-cell *matHeaderCellDef>Key</th>
        <td mat-cell *matCellDef="let element">
          <step-form-field>
            <input [(ngModel)]="element.key" placeholder="Key" (blur)="_userState.savePreferences()" />
          </step-form-field>
        </td>
      </ng-container>
      <ng-container matColumnDef="value">
        <th mat-header-cell *matHeaderCellDef>Value</th>
        <td mat-cell *matCellDef="let element">
          <step-form-field>
            <input [(ngModel)]="element.value" placeholder="Value" (blur)="_userState.savePreferences()" />
          </step-form-field>
        </td>
      </ng-container>
      <ng-container matColumnDef="actions">
        <th class="actions" mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let element">
          <button mat-icon-button matTooltip="Delete preference" (click)="_userState.removePreference(element)">
            <step-icon name="trash-2" />
          </button>
        </td>
      </ng-container>
    </step-table>
  </mat-card-content>
</mat-card>
