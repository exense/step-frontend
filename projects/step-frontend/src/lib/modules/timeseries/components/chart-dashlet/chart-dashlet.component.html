<div>
  @if (!_internalSettings) {
    <step-chart-skeleton></step-chart-skeleton>
  } @else {
    <step-timeseries-chart
      #chart
      (zoomReset)="handleZoomReset()"
      [syncKey]="context.id"
      [settings]="_internalSettings!"
      (lockStateChange)="handleLockStateChange($event)"
      [height]="height"
    />
  }
</div>

<div class="settings-container">
  <div class="edit-buttons" *ngIf="editMode">
    <button mat-icon-button matTooltip="Shift left" (click)="shiftLeft.emit()">
      <step-icon name="chevron-left"></step-icon>
    </button>
    <button mat-icon-button matTooltip="Shift right" (click)="shiftRight.emit()">
      <step-icon name="chevron-right"></step-icon>
    </button>
    <button mat-icon-button matTooltip="Edit settings" (click)="openChartSettings()">
      <step-icon name="edit"></step-icon>
    </button>
    <button mat-icon-button matTooltip="Remove chart" (click)="remove.emit()">
      <step-icon name="x"></step-icon>
    </button>
  </div>
  @if (!editMode && !((item.readonlyGrouping || item.inheritGlobalGrouping) && item.readonlyAggregate)) {
    <button mat-icon-button matTooltip="Settings" [matMenuTriggerFor]="settingsMenu">
      <step-icon name="settings"></step-icon>
    </button>
  }

  <mat-menu #settingsMenu="matMenu">
    @if (!item.masterChartId && !item.readonlyGrouping && !item.inheritGlobalGrouping) {
      <button mat-menu-item [matMenuTriggerFor]="groupingMenu">Grouping</button>
    }
    @if (!item.readonlyAggregate) {
      <button mat-menu-item [matMenuTriggerFor]="aggregateMenu">Aggregate</button>
    }
  </mat-menu>

  <mat-menu #groupingMenu="matMenu">
    @for (attribute of groupingSelection; track attribute) {
      <button
        (click)="toggleGroupingAttribute(attribute); $event.stopPropagation()"
        mat-menu-item
        [class.selected-menu-item]="attribute.selected"
      >
        <div class="flex flex-row checkbox-row">
          <input type="checkbox" class="checkbox" [ngModel]="attribute.selected" />
          <span>{{ attribute.displayName }}</span>
        </div>
      </button>
    }
  </mat-menu>

  <mat-menu #aggregateMenu="matMenu">
    @for (aggregate of AGGREGATES; track aggregate) {
      <button
        (click)="switchAggregate(aggregate)"
        mat-menu-item
        class="selected-menu-item"
        [class.selected-menu-item]="aggregate === selectedAggregate"
      >
        {{ aggregate }}
      </button>
    }
    <button
      mat-menu-item
      [matMenuTriggerFor]="pclMenu"
      [class.selected-menu-item]="selectedAggregate === ChartAggregation.PERCENTILE"
    >
      PERCENTILE
    </button>
  </mat-menu>

  <mat-menu #pclMenu="matMenu">
    @for (pcl of PCL_VALUES; track pcl) {
      <button
        (click)="switchAggregate(ChartAggregation.PERCENTILE, pcl)"
        [class.selected-menu-item]="selectedAggregate === ChartAggregation.PERCENTILE && selectedPclValue === pcl"
        mat-menu-item
      >
        {{ pcl }}th
      </button>
    }
  </mat-menu>
</div>
