<step-modal-window title="Chart settings" [stepZIndex]="1000">
  <div step-modal-window-body>
    <form #formContainer="ngForm">
      <ng-container *ngIf="item">
        <div class="form-row">
          <step-form-field [showRequiredMarker]="true">
            <step-label>Name</step-label>
            <input placeholder="Dashlet name" [(ngModel)]="item.name" name="name" required />
          </step-form-field>
        </div>
        <div class="form-row">
          <step-form-field>
            <step-label>Type</step-label>
            <input disabled placeholder="Type" [value]="item.type" name="type" />
          </step-form-field>

          <step-form-field>
            <step-label>Metric</step-label>
            <input disabled placeholder="Metric" [value]="item.metricKey" name="metricKey" />
          </step-form-field>
        </div>
        <mat-divider />
        <div>
          <step-label>Filters and grouping</step-label>
        </div>
        <div class="filters-container">
          <step-ts-filter-bar-item
            *ngFor="let item of filterItems; let i = index"
            [item]="item"
            (removeItem)="filterItems.splice(i, 1)"
            [removable]="true"
            [updateTimeRangeOption]="false"
          ></step-ts-filter-bar-item>
          <button mat-button [matMenuTriggerFor]="typesMenu">+ Add Filter</button>
        </div>
        <mat-menu #typesMenu="matMenu">
          <button mat-menu-item *ngFor="let attribute of item.attributes" (click)="addFilterItem(attribute)">
            {{ attribute.displayName }}
          </button>
          <button mat-menu-item (click)="addCustomFilter(FilterBarItemType.FREE_TEXT)">Text Filter</button>
          <button mat-menu-item (click)="addCustomFilter(FilterBarItemType.NUMERIC)">Numeric Filter</button>
          <button mat-menu-item (click)="addCustomFilter(FilterBarItemType.DATE)">Date Filter</button>
        </mat-menu>
        <div class="form-row">
          <div>
            <step-form-field>
              <mat-checkbox color="primary" [(ngModel)]="item.inheritGlobalFilters" name="inheritGlobalFilters">
                <span>Inherit global filters</span>
                <step-icon
                  class="help-icon"
                  matTooltip="The chart filters will be combined with the dashboard filters"
                  name="help-circle"
                ></step-icon>
              </mat-checkbox>
            </step-form-field>
            <step-form-field>
              <mat-checkbox color="primary" [(ngModel)]="item.inheritGlobalGrouping" name="inheritGlobalGrouping">
                <span>Inherit global grouping</span>
                <step-icon
                  class="help-icon"
                  matTooltip="The grouping will be inherited from the dashboard level"
                  name="help-circle"
                ></step-icon>
              </mat-checkbox>
            </step-form-field>
          </div>
          <div>
            <step-form-field>
              <mat-checkbox color="primary" [(ngModel)]="item.readonlyGrouping" name="readonlyGrouping">
                <span>Readonly grouping</span>
                <step-icon
                  class="help-icon"
                  matTooltip="The users will not be able to change the grouping of this dashlet"
                  name="help-circle"
                ></step-icon>
              </mat-checkbox>
            </step-form-field>
            <step-form-field>
              <mat-checkbox color="primary" [(ngModel)]="item.readonlyAggregate" name="readonlyAggregate">
                <span>Readonly aggregate</span>
                <step-icon
                  class="help-icon"
                  matTooltip="The users will not be able to change the aggregate of this dashlet"
                  name="help-circle"
                ></step-icon>
              </mat-checkbox>
            </step-form-field>
          </div>
        </div>

        <step-form-field *ngIf="!item.inheritGlobalGrouping">
          <step-label>Grouping</step-label>
          <mat-select [(ngModel)]="item.grouping" multiple name="grouping">
            <mat-option *ngFor="let attr of item.attributes" [value]="attr.name">{{ attr.displayName }}</mat-option>
          </mat-select>
        </step-form-field>
        <mat-divider />
        <step-label>Columns</step-label>
        <div class="columns-container">
          @for (column of item.tableSettings!.columns; track column.column) {
            <mat-checkbox
              color="primary"
              [(ngModel)]="column.selected"
              [ngModelOptions]="{ standalone: true }"
              class="item"
            >
              <span>{{ column.column }}</span>
            </mat-checkbox>
          }
        </div>
        <mat-divider />
      </ng-container>
    </form>
  </div>

  <div step-modal-window-buttons>
    <button type="button" mat-stroked-button mat-dialog-close>Cancel</button>
    <button type="button" (click)="save()" mat-flat-button color="primary">Apply</button>
  </div>
</step-modal-window>
