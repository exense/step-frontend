<div class="time-container">
  <div class="ranger-section" [class.compact]="compactView">
    <step-execution-time-selection [context]="context"></step-execution-time-selection>
  </div>
  <div>
    <step-time-range-picker
      (selectionChange)="handleTimeRangeChange($event)"
      [selectOptions]="timeRangeOptions"
      [activeSelection]="activeTimeRange"
      [compact]="compactView"
    >
    </step-time-range-picker>
  </div>
</div>

<div class="filters-section">
  <step-alert type="warning" class="warning" *ngIf="rawMeasurementsModeActive">
    You are using custom filters which may slow down the dashboard.
  </step-alert>

  <div class="settings-section" *ngIf="compactView">
    <mat-button-toggle-group [(ngModel)]="oqlModeActive" (change)="toggleOQLMode()">
      <mat-button-toggle [value]="false"> Basic</mat-button-toggle>
      <mat-button-toggle [value]="true"> OQL</mat-button-toggle>
    </mat-button-toggle-group>
    <step-timeseries-grouping
      [dimensions]="activeGrouping"
      (groupingChange)="handleGroupingChange($event)"
    ></step-timeseries-grouping>
  </div>

  <div class="filters">
    <mat-menu #addFilterMenu="matMenu">
      <ng-container *ngFor="let option of filterOptions">
        <button mat-menu-item *ngIf="!option.isHidden" (click)="addFilterItem(option)">
          <span>{{ option.label }}</span>
        </button>
      </ng-container>
      <button mat-menu-item [matMenuTriggerFor]="typesMenu">Other</button>
      <button mat-menu-item (click)="openDiscovery()">Discover...</button>
    </mat-menu>

    <mat-menu #typesMenu="matMenu">
      <button mat-menu-item (click)="addCustomFilter(FilterBarItemType.FREE_TEXT)">Text Filter</button>
      <button mat-menu-item (click)="addCustomFilter(FilterBarItemType.NUMERIC)">Numeric Filter</button>
      <button mat-menu-item (click)="addCustomFilter(FilterBarItemType.DATE)">Date Filter</button>
    </mat-menu>

    <div
      class="filers-row"
      [style]="oqlModeActive ? 'overflow: unset' : ''"
      [style.flexWrap]="compactView ? 'wrap' : 'nowrap'"
    >
      <ng-container *ngIf="!oqlModeActive">
        <ng-container *ngFor="let item of activeFilters; let i = index">
          <step-ts-filter-bar-item
            #appliedFilter
            *ngIf="!item.isHidden"
            [item]="item"
            [compact]="compactView"
            [removable]="item.removable"
            (removeItem)="removeFilterItem(i)"
            (filterChange)="handleFilterChange(i, $event)"
          >
          </step-ts-filter-bar-item>
        </ng-container>
        <div class="more-btn-container" [matMenuTriggerFor]="addFilterMenu">
          <div class="more-btn filter-item-container">
            <span>More</span>
            <step-icon name="plus"></step-icon>
          </div>
        </div>
      </ng-container>
      <ng-container *ngIf="oqlModeActive">
        <div class="flex flex-grow-1 relative oql-container">
          <input
            [title]="oqlValue"
            [(ngModel)]="oqlValue"
            class="oql-input"
            (ngModelChange)="handleOqlChange($event)"
            [class.invalid-input]="invalidOql"
          />
          <step-icon
            class="info-btn"
            name="help-circle"
            matTooltip="Advanced Filtering with Object Query Language (OQL) lets you define custom, complex filters beyond the predefined options. Using OQL, you can query specific attributes, compare values, or combine conditions to refine your data. Consult our documentation for OQL syntax and usage guidance."
          ></step-icon>
          <span *ngIf="invalidOql" class="error-info">Invalid OQL</span>
        </div>
        <button class="apply-btn" mat-button color="primary" (click)="manuallyApplyFilters()">Apply Filters</button>
      </ng-container>
      <button
        class="apply-btn"
        color="primary"
        *ngIf="!oqlModeActive && rawMeasurementsModeActive"
        mat-button
        (click)="manuallyApplyFilters()"
      >
        Apply Filters
      </button>
    </div>

    <div class="settings-section" *ngIf="!compactView">
      <mat-button-toggle-group [(ngModel)]="oqlModeActive" (change)="toggleOQLMode()">
        <mat-button-toggle [value]="false"> Basic</mat-button-toggle>
        <mat-button-toggle [value]="true"> OQL</mat-button-toggle>
      </mat-button-toggle-group>
      <step-timeseries-grouping
        [dimensions]="activeGrouping"
        (groupingChange)="handleGroupingChange($event)"
      ></step-timeseries-grouping>
    </div>
  </div>
</div>
