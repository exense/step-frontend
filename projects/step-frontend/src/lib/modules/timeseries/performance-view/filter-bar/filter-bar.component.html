<step-alert type="warning" class="warning" *ngIf="rawMeasurementsModeActive">
  You are using custom filters which may slow down the dashboard.
</step-alert>
<div class="filters">
  <mat-menu #menu="matMenu">
    <button mat-menu-item *ngFor="let option of _defaultFilterOptions" (click)="addFilterItem(option)">
      <span>{{ option.label }}</span>
    </button>

    <button mat-menu-item [matMenuTriggerFor]="typesMenu">
      <span>Other</span>
    </button>

    <button mat-menu-item disabled>
      <span>OQL</span>
    </button>
  </mat-menu>

  <mat-menu #typesMenu="matMenu">
    <button mat-menu-item (click)="addCustomFilter(FilterBarItemType.FREE_TEXT)">Text Filter</button>
    <button mat-menu-item (click)="addCustomFilter(FilterBarItemType.NUMERIC)">Numeric Filter</button>
    <button mat-menu-item (click)="addCustomFilter(FilterBarItemType.DATE)">Date Filter</button>
  </mat-menu>

  <div class="applied-filters" [style]="oqlModeActive ? 'overflow: unset' : ''">
    <ng-container *ngIf="!oqlModeActive">
      <ng-container *ngFor="let item of filterItems; let i = index">
        <step-ts-filter-bar-item
          *ngIf="!item.isHidden"
          #appliedFilter
          [item]="item"
          [removable]="item.removable"
          (onRemoveItem)="removeFilterItem(i)"
          (onFilterChange)="handleFilterChange(i, $event)"
        >
        </step-ts-filter-bar-item>
      </ng-container>
      <div class="more-btn-container" [matMenuTriggerFor]="typesMenu">
        <div class="more-btn filter-item-container">
          <span>More</span>
          <step-icon name="plus"></step-icon>
        </div>
      </div>
    </ng-container>
    <ng-container *ngIf="oqlModeActive">
      <div class="flex flex-grow-1 relative oql-container">
        <input
          [title]="oqlValue"
          [(ngModel)]="oqlValue"
          class="oql-input"
          (ngModelChange)="handleOqlChange($event)"
          [class.invalid-input]="invalidOql"
        />
        <step-icon
          class="info-btn"
          name="help-circle"
          matTooltip="Advanced Filtering with Object Query Language (OQL) lets you define custom, complex filters beyond the predefined options. Using OQL, you can query specific attributes, compare values, or combine conditions to refine your data. Consult our documentation for OQL syntax and usage guidance."
        ></step-icon>
        <span *ngIf="invalidOql" class="error-info">Invalid OQL</span>
      </div>
      <button class="apply-btn" mat-button color="primary" (click)="manuallyApplyFilters()">Apply Filters</button>
    </ng-container>
    <button
      class="apply-btn"
      color="primary"
      *ngIf="!oqlModeActive && rawMeasurementsModeActive"
      mat-button
      (click)="manuallyApplyFilters()"
    >
      Apply Filters
    </button>
  </div>

  <div class="settings-section">
    <mat-button-toggle-group [(ngModel)]="oqlModeActive" (change)="toggleOQLMode()">
      <mat-button-toggle [value]="false"> Basic</mat-button-toggle>
      <mat-button-toggle [value]="true"> OQL</mat-button-toggle>
    </mat-button-toggle-group>
    <step-timeseries-grouping (onGroupingChange)="handleGroupingChange($event)"></step-timeseries-grouping>
  </div>
</div>

<step-execution-time-selection [context]="context"></step-execution-time-selection>
