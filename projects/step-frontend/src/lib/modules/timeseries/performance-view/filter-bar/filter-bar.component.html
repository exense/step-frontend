<div class="filters">
  <div class="warning-mark" *ngIf="rawMeasurementsModeActive">
    You are using custom filters which may slow down the dashboard. Please be patient.
  </div>

  <mat-menu #menu="matMenu">
    <button mat-menu-item *ngFor="let option of defaultFilterOptions" (click)="addFilterItem(option)">
      <span>{{ option.label }}</span>
    </button>

    <button mat-menu-item [matMenuTriggerFor]="typesMenu">
      <span>Other</span>
    </button>

    <button mat-menu-item disabled>
      <span>OQL</span>
    </button>
  </mat-menu>

  <mat-menu #typesMenu="matMenu">
    <button mat-menu-item (click)="addCustomFilter(FilterBarItemType.FREE_TEXT)">Text Filter</button>
    <button mat-menu-item (click)="addCustomFilter(FilterBarItemType.NUMERIC)">Numeric Filter</button>
    <button mat-menu-item (click)="addCustomFilter(FilterBarItemType.DATE)">Date Filter</button>
  </mat-menu>

  <div class="applied-filters" [style]="oqlModeActive ? 'overflow: unset' : ''">
    <step-timeseries-grouping (onGroupingChange)="handleGroupingChange($event)"></step-timeseries-grouping>
    <ng-container *ngIf="!oqlModeActive">
      <step-ts-filter-bar-item
        *ngFor="let item of visibleFilters; let i = index"
        #appliedFilter
        [item]="item"
        [removable]="item.removable"
        (onRemoveItem)="removeFilterItem(i)"
        (onFilterChange)="handleFilterChange(i, $event)"
      >
      </step-ts-filter-bar-item>
      <div class="more-btn-container" [matMenuTriggerFor]="typesMenu">
        <div class="more-btn filter-item-container">
          <span>More</span>
          <step-icon name="plus"></step-icon>
        </div>
      </div>
    </ng-container>
    <ng-container *ngIf="oqlModeActive">
      <div class="flex flex-grow-1 relative oql-container">
        <input
          [title]="oqlValue"
          [(ngModel)]="oqlValue"
          class="oql-input"
          (ngModelChange)="handleOqlChange($event)"
          [class.invalid-input]="invalidOql"
        />
        <step-icon
          class="info-btn"
          name="help-circle"
          matTooltip="This is something very very advanced. Please be careful!"
        ></step-icon>
        <span *ngIf="invalidOql" class="error-info">Invalid OQL</span>
      </div>
      <button class="apply-btn" mat-button color="basic" (click)="manuallyApplyFilters()">Apply Filters</button>
    </ng-container>
    <button
      class="apply-btn"
      *ngIf="!oqlModeActive && rawMeasurementsModeActive"
      mat-button
      (click)="manuallyApplyFilters()"
    >
      Apply Filters
    </button>
  </div>

  <mat-button-toggle-group [(ngModel)]="oqlModeActive" (change)="toggleOQLMode()">
    <mat-button-toggle [value]="false"> Basic</mat-button-toggle>
    <mat-button-toggle [value]="true"> OQL</mat-button-toggle>
  </mat-button-toggle-group>
</div>

<step-execution-time-selection [settings]="performanceViewSettings"></step-execution-time-selection>

<div class="export-btn" (click)="exportRawData()">
  <span matTooltip="Download CSV" *ngIf="!exportInProgress"><step-icon name="download"></step-icon></span>
  <mat-spinner *ngIf="exportInProgress" [diameter]="16"></mat-spinner>
</div>
