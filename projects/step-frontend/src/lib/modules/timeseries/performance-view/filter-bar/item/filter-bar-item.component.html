<div
  class="filter-item-container"
  [class.active]="active"
  [matMenuTriggerFor]="menu"
  #matTrigger="matMenuTrigger"
  (menuOpened)="onMenuOpen(); focusables.scheduleRefocus()"
>
  <div class="filter-label">{{ item.label || 'Unspecified' }}</div>
  <div class="filter-value">{{ formattedValue || '-' }}</div>

  <div (click)="onRemoveItem.emit()" class="remove-btn" *ngIf="removable">
    <step-icon class="remove-btn" name="x"></step-icon>
  </div>
</div>

<mat-menu #menu="matMenu" [ngSwitch]="item.type" (close)="onMenuClose()">
  <form
    class="menu-container"
    (click)="$event.stopPropagation()"
    stepTrapFocus
    stepFocusables
    #focusables="stepFocusables"
  >
    <div *ngSwitchCase="FilterBarType.OPTIONS">
      <div class="item-header">
        {{ item.label }}
      </div>

      <div class="checkboxes">
        <mat-checkbox
          *ngFor="let option of item.textValues; let i = index"
          #checkbox
          color="primary"
          [name]="option.value"
          [ngModel]="option.isSelected"
          (change)="toggleOption(option, $event.checked)"
          stepFocusable
          [defaultSpace]="false"
          (keydownSpace)="toggleOption(option, !option.isSelected, checkbox)"
          [stepRecursiveTabIndex]="-1"
        >
          {{ option.value }}
        </mat-checkbox>
      </div>
    </div>

    <div *ngSwitchCase="FilterBarType.FREE_TEXT">
      <mat-form-field *ngIf="!item.isLocked" class="w-100">
        <mat-label>Attribute name</mat-label>
        <input
          type="text"
          autocomplete="off"
          [readonly]="item.isLocked"
          matInput
          name="attributeName"
          [(ngModel)]="item.attributeName"
          stepFocusable
        />
      </mat-form-field>

      <mat-form-field class="w-100">
        <mat-label>Search value</mat-label>
        <input type="text" autocomplete="off" matInput name="textValue" [(ngModel)]="freeTextValue" stepFocusable />
      </mat-form-field>

      <button
        type="submit"
        class="w-100"
        (click)="applyChanges()"
        mat-raised-button
        color="primary"
        stepFocusable
        [defaultSpace]="false"
        (keydownSpace)="applyChanges()"
      >
        Apply
      </button>
    </div>

    <div *ngSwitchCase="FilterBarType.NUMERIC">
      <mat-form-field *ngIf="!item.isLocked" class="w-100">
        <mat-label>Attribute name</mat-label>
        <input
          type="text"
          autocomplete="off"
          [readonly]="item.isLocked"
          matInput
          name="attributeName"
          [(ngModel)]="item.attributeName"
          stepFocusable
        />
      </mat-form-field>

      <mat-form-field class="w-100">
        <mat-label>Min</mat-label>
        <input type="number" matInput name="min" [(ngModel)]="minValue" stepFocusable />
      </mat-form-field>

      <mat-form-field class="w-100">
        <mat-label>Max</mat-label>
        <input type="number" matInput name="max" [(ngModel)]="maxValue" stepFocusable />
      </mat-form-field>

      <button
        type="submit"
        class="w-100"
        (click)="applyChanges()"
        mat-raised-button
        color="primary"
        stepFocusable
        [defaultSpace]="false"
        (keydownSpace)="applyChanges()"
      >
        Apply
      </button>
    </div>

    <div *ngSwitchCase="FilterBarType.DATE">
      <mat-form-field *ngIf="!item.isLocked" class="w-100">
        <mat-label>Attribute name</mat-label>
        <input
          type="text"
          autocomplete="off"
          [readonly]="item.isLocked"
          matInput
          name="attributeName"
          [(ngModel)]="item.attributeName"
          stepFocusable
        />
      </mat-form-field>

      <div class="date-filters">
        <step-date-filter
          label="From"
          (filterChange)="onMinDateChanged($event)"
          #from="stepDateFilter"
          stepFocusable
          [defaultSpace]="false"
          (keydownSpace)="from.matDatepicker?.open()"
          [stepRecursiveTabIndex]="-1"
        ></step-date-filter>

        <step-date-filter
          label="To"
          (filterChange)="onMaxDateChanged($event)"
          #to="stepDateFilter"
          stepFocusable
          [defaultSpace]="false"
          (keydownSpace)="to.matDatepicker?.open()"
          [stepRecursiveTabIndex]="-1"
        ></step-date-filter>
      </div>

      <button
        type="submit"
        class="w-100"
        (click)="applyChanges()"
        mat-raised-button
        color="primary"
        stepFocusable
        [defaultSpace]="false"
        (keydownSpace)="applyChanges()"
      >
        Apply
      </button>
    </div>
  </form>
</mat-menu>
