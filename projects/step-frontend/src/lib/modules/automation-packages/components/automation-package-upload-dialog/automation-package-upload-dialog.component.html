<step-modal-window [title]="dialogTitle" [disableCloseByEsc]="!!progress$">
  <div class="advanced-settings-toggle" step-modal-window-title>
    <button tabindex="-1" mat-icon-button matTooltip="Display Advanced Settings" (click)="toggleAdvancedSettings()">
      <step-icon [class.active]="showAdvancedSettings" name="settings"></step-icon>
    </button>
  </div>
  <div step-modal-window-body>
    @if (progress$) {
      <step-progress-bar [progress]="(progress$ | async)!" />
    } @else {
      @if (isAffectingOtherPackage) {
        <step-alert [type]="AlertType.MINIMALIST">
          This automation package would also update other packages. Select "Force" to proceed.
        </step-alert>
      }
      <form [formGroup]="form">
        @switch (automationPackageFile.uploadType) {
          @case (UploadType.UPLOAD) {
            <step-upload-container (filesChange)="handleDrop(automationPackageFile, $event)">
              <step-form-field alignLabelAddon="near" [showRequiredMarker]="isNewPackage">
                <step-label>Automation Package (jar or ZIP file)</step-label>
                <step-label-addon>
                  <step-icon
                    name="help-circle"
                    matTooltip="Drag & Drop or select your automation package jar / ZIP file"
                  />
                </step-label-addon>
                <input type="text" readonly formControlName="apFileName" name="fileName" />
                <step-suffix class="button-suffix">
                  <button type="button" mat-stroked-button (click)="openFileChooseDialog(automationPackageFile)">
                    <step-icon name="folder-plus"></step-icon>
                  </button>
                </step-suffix>
                <step-suffix class="button-suffix">
                  <button
                    type="button"
                    class="maven"
                    mat-stroked-button
                    (click)="toggleMavenUpload(automationPackageFile)"
                    matTooltip="Use maven snippet instead of uploading a file."
                  >
                    <step-icon name="maven"></step-icon>
                  </button>
                </step-suffix>
              </step-form-field>
            </step-upload-container>
          }
          @case (UploadType.MAVEN) {
            <step-form-field alignLabelAddon="near" [showRequiredMarker]="isNewPackage">
              <step-label>Automation Package (Maven Snippet)</step-label>
              <step-label-addon>
                <button
                  type="button"
                  class="active maven"
                  mat-stroked-button
                  (click)="toggleMavenUpload(automationPackageFile)"
                  matTooltip="Use upload a file instead of using maven snippet."
                >
                  <step-icon name="maven"></step-icon>
                </button>
              </step-label-addon>
              <step-rich-editor [syntaxMode]="AceMode.XML" formControlName="apMavenSnippet" />
            </step-form-field>
          }
          @default {}
        }

        <input #automationPackageFileInput type="file" (input)="selectFile(automationPackageFile)" />
        <input #libraryFileInput type="file" (input)="selectFile(libraryFile)" />

        @if (showAdvancedSettings) {
          <step-label>Libraries</step-label>
          @switch (libraryFile.uploadType) {
            @case (UploadType.UPLOAD) {
              <step-upload-container (filesChange)="handleDrop(libraryFile, $event)">
                <step-form-field alignLabelAddon="near">
                  <step-description
                    >Select a jar or ZIP file as a dependency for this automation package.</step-description
                  >
                  <input type="text" readonly formControlName="libraryFileName" name="libraryName" />
                  <step-suffix class="button-suffix">
                    <button type="button" mat-stroked-button (click)="openFileChooseDialog(libraryFile)">
                      <step-icon name="folder-plus"></step-icon>
                    </button>
                  </step-suffix>
                  <step-suffix class="button-suffix">
                    <button
                      type="button"
                      mat-stroked-button
                      matTooltip="Select an existing resource"
                      (click)="selectResource()"
                    >
                      <step-icon name="search"></step-icon>
                    </button>
                  </step-suffix>
                  <step-suffix class="button-suffix">
                    <button
                      type="button"
                      class="maven"
                      mat-stroked-button
                      (click)="toggleMavenUpload(libraryFile)"
                      matTooltip="Use maven snippet instead of uploading a file."
                    >
                      <step-icon name="maven"></step-icon>
                    </button>
                  </step-suffix>
                </step-form-field>
              </step-upload-container>
            }
            @case (UploadType.MAVEN) {
              <step-form-field alignLabelAddon="near" [showRequiredMarker]="isNewPackage">
                <step-label>Maven Snippet</step-label>
                <step-label-addon>
                  <button
                    type="button"
                    class="active maven"
                    mat-stroked-button
                    (click)="toggleMavenUpload(libraryFile)"
                    matTooltip="Upload a file instead of using maven snippet."
                  >
                    <step-icon name="maven"></step-icon>
                  </button>
                </step-label-addon>
                <step-rich-editor [syntaxMode]="AceMode.XML" formControlName="libraryMavenSnippet" />
              </step-form-field>
            }
            @default {}
          }
          <step-label>Versioning</step-label>
          <step-form-field alignLabelAddon="near">
            <step-description
              >Optional: specify a package version. This lets you deploy and run different versions on Step, controlled
              by an activation expression.
            </step-description>
            <step-prefix>Version</step-prefix>
            <input placeholder="Version (optional)" formControlName="version" name="version" title="Version" />
            <step-suffix>
              <step-icon
                name="help-circle"
                matTooltip="This value can be used to differentiate multiple versions of the same automation package (i.e. 1.0.0)"
              />
            </step-suffix>
          </step-form-field>
          <step-form-field>
            <step-prefix>Activation Expression</step-prefix>
            <input
              placeholder="Activation Expression (optional)"
              name="activationExpression"
              formControlName="activationExpression"
              title="Activation Expression"
            />
            <step-suffix>
              <step-icon
                name="help-circle"
                matTooltip="The activation expression is used to select the automation packages version during the execution of plans. Example: env == PROD"
              />
            </step-suffix>
          </step-form-field>
          <mat-expansion-panel [class.hidden]="!customKeywordAttributesForm.inputs().length">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <span>Custom keyword attributes</span>
                &nbsp;
                <step-icon
                  name="help-circle"
                  matTooltip="Custom attributes applied to all keywords and derived from the keyword screenInput"
                ></step-icon>
              </mat-panel-title>
            </mat-expansion-panel-header>
            <step-custom-forms
              #customKeywordAttributesForm
              [(stModel)]="customKeywordAttributes"
              stScreen="keyword"
              [stExcludeFields]="['attributes.name']"
            >
            </step-custom-forms>
          </mat-expansion-panel>
          <mat-expansion-panel [class.hidden]="!customPlanAttributesForm.inputs().length">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <span>Custom plan attributes</span>
                &nbsp;
                <step-icon
                  name="help-circle"
                  matTooltip="Custom attributes applied to all plans and derived from the plan screenInput"
                ></step-icon>
              </mat-panel-title>
            </mat-expansion-panel-header>
            <step-custom-forms
              #customPlanAttributesForm
              [(stModel)]="customPlanAttributes"
              stScreen="plan"
              [stExcludeFields]="['attributes.name']"
            >
            </step-custom-forms>
          </mat-expansion-panel>
          <mat-expansion-panel>
            <mat-expansion-panel-header>
              <mat-panel-title>Routing options</mat-panel-title>
            </mat-expansion-panel-header>
            <mat-checkbox color="primary" [(ngModel)]="_package.executeFunctionLocally">
              <span>Execute on controller</span>
              &nbsp;
              <step-icon
                name="help-circle"
                matTooltip="Defines if the Keywords of this package should be executed on an agent or locally on the controller. Please change this only if you really now what you're doing. In most of the cases the default setting doesn't have to be changed."
              ></step-icon>
            </mat-checkbox>
            @if (_package.executeFunctionLocally) {
              <section class="criteria-header">
                <div>
                  <label>Agent token selection criteria</label>
                  <button type="button" mat-icon-button (click)="addRoutingCriteria()">
                    <step-icon name="plus"></step-icon>
                  </button>
                </div>
                <step-icon
                  name="help-circle"
                  matTooltip="Defines additional selection criteria for the agent token on which the keywords of this package should be executed"
                >
                </step-icon>
              </section>
              <section class="criteria-body">
                @for (criterion of criteria; track criterion.id) {
                  <step-form-field>
                    <input type="text" placeholder="Key" [(ngModel)]="criterion.key" (blur)="saveRoutingCriteria()" />
                  </step-form-field>
                  <step-form-field>
                    <input
                      type="text"
                      placeholder="Value"
                      [(ngModel)]="criterion.value"
                      (blur)="saveRoutingCriteria()"
                    />
                  </step-form-field>
                  <button type="button" mat-stroked-button (click)="removeRoutingCriteria(criterion)">
                    <step-icon name="trash-2"></step-icon>
                  </button>
                }
              </section>
            }
          </mat-expansion-panel>
        }
      </form>
    }
  </div>
  <div step-modal-window-buttons>
    <button type="button" mat-stroked-button mat-dialog-close [disabled]="!!progress$">Cancel</button>
    <button type="button" mat-flat-button color="primary" (click)="upload()" [disabled]="!!progress$">
      @if (isAffectingOtherPackage) {
        Force&nbsp;
      }
      @if (!isNewPackage) {
        Update
      } @else {
        @switch (automationPackageFile.uploadType) {
          @case (UploadType.UPLOAD) {
            Upload
          }
          @case (UploadType.MAVEN) {
            Add
          }
          @default {}
        }
      }
    </button>
  </div>
</step-modal-window>
