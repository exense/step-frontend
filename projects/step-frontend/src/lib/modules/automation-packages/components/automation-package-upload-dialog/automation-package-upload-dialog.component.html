<step-modal-window [title]="dialogTitle" [disableCloseByEsc]="!!progress$">
  <div class="advanced-settings-toggle" step-modal-window-title>
    <button tabindex="-1" mat-icon-button matTooltip="Display Advanced Settings" (click)="toggleAdvancedSettings()">
      <step-icon [class.active]="showAdvancedSettings" name="settings"></step-icon>
    </button>
  </div>
  <div step-modal-window-body>
    @if (progress$) {
      <step-progress-bar [progress]="(progress$ | async)!" />
    } @else {
      @if (isAffectingOtherPackage) {
        <step-alert [type]="AlertType.MINIMALIST">
          This automation package would also update other packages. Select "Force" to proceed.
        </step-alert>
      }
      <form [formGroup]="form">
        @switch (apType) {
          @case (UploadType.UPLOAD) {
            <step-form-field alignLabelAddon="near" [showRequiredMarker]="isNewPackage">
              <step-label>Automation Package (jar or ZIP file)</step-label>
              <step-label-addon>
                <step-icon
                  name="help-circle"
                  matTooltip="Drag & Drop or select your automation package jar / ZIP file"
                />
              </step-label-addon>

              <step-resource-input
                resourceType="automationPackage"
                [disableServerPath]="true"
                [withClearButton]="false"
                [withChooseExistingResourceButton]="false"
                formControlName="apFile"
              >
                <step-suffix class="button-suffix">
                  <button
                    type="button"
                    class="maven"
                    mat-stroked-button
                    (click)="switchApType(UploadType.MAVEN)"
                    matTooltip="Use maven snippet instead of uploading a file."
                  >
                    <step-icon name="maven"></step-icon>
                  </button>
                </step-suffix>
              </step-resource-input>
            </step-form-field>
          }
          @case (UploadType.MAVEN) {
            <step-form-field alignLabelAddon="near" [showRequiredMarker]="isNewPackage">
              <step-label>Automation Package (Maven Snippet)</step-label>
              <step-label-addon>
                <button
                  type="button"
                  class="active maven"
                  mat-stroked-button
                  (click)="apType = UploadType.UPLOAD"
                  matTooltip="Use upload a file instead of using maven snippet."
                >
                  <step-icon name="maven"></step-icon>
                </button>
              </step-label-addon>
              <step-rich-editor #apSnippetEditor [syntaxMode]="AceMode.XML" formControlName="apMavenSnippet" />
            </step-form-field>
          }
          @default {}
        }
        @if (showAdvancedSettings) {
          @switch (libraryType) {
            @case (UploadType.UPLOAD) {
              <step-label>Libraries</step-label>
              <step-form-field alignLabelAddon="near">
                <step-description>
                  Select a jar or ZIP file as a dependency for this automation package.
                </step-description>
                <step-resource-input
                  resourceType="automationPackageLibrary"
                  [disableServerPath]="true"
                  [withClearButton]="true"
                  [withChooseExistingResourceButton]="true"
                  [searchTypes]="existingLibrariesSearchTypes"
                  formControlName="libraryFile"
                >
                  <step-suffix class="button-suffix">
                    <button
                      type="button"
                      class="maven"
                      mat-stroked-button
                      (click)="switchLibraryType(UploadType.MAVEN)"
                      matTooltip="Use maven snippet instead of uploading a file."
                    >
                      <step-icon name="maven"></step-icon>
                    </button>
                  </step-suffix>
                </step-resource-input>
              </step-form-field>
            }
            @case (UploadType.MAVEN) {
              <step-label>Libraries (Maven Snippet)</step-label>
              <step-form-field alignLabelAddon="near">
                <step-description>
                  Select a maven snippet as a dependency for this automation package.
                </step-description>
                <step-label-addon>
                  <button
                    type="button"
                    class="active maven"
                    mat-stroked-button
                    (click)="libraryType = UploadType.UPLOAD"
                    matTooltip="Upload a file instead of using maven snippet."
                  >
                    <step-icon name="maven"></step-icon>
                  </button>
                </step-label-addon>
                <step-rich-editor
                  #librarySnippetEditor
                  [syntaxMode]="AceMode.XML"
                  formControlName="libraryMavenSnippet"
                />
              </step-form-field>
            }
            @default {}
          }
          <step-label>Versioning</step-label>
          <step-form-field alignLabelAddon="near">
            <step-description
              >Optional: specify a package version. This lets you deploy and run different versions on Step, controlled
              by an activation expression.
            </step-description>
            <step-prefix>Version name</step-prefix>
            <input
              placeholder="Version name (optional)"
              formControlName="versionName"
              name="versionName"
              title="Version name"
            />
            <step-suffix>
              <step-icon
                name="help-circle"
                matTooltip="This value can be used to differentiate multiple versions of the same automation package (i.e. 1.0.0)"
              />
            </step-suffix>
          </step-form-field>
          <step-form-field>
            <step-prefix>Activation Expression</step-prefix>
            <input
              placeholder="Activation Expression (optional)"
              name="activationExpression"
              formControlName="activationExpression"
              title="Activation Expression"
            />
            <step-suffix>
              <step-icon
                name="help-circle"
                matTooltip="The activation expression is used to select the automation packages version during the execution of plans. Example: env == PROD"
              />
            </step-suffix>
          </step-form-field>
          <div [class.hidden]="!customKeywordAttributesForm.inputs().length">
            <h5>Custom keyword attributes</h5>
            <step-description>
              Custom attributes applied to all keywords and derived from the keyword screenInput
            </step-description>
            <step-custom-forms
              #customKeywordAttributesForm
              [(stModel)]="customKeywordAttributes"
              stScreen="keyword"
              [stExcludeFields]="['attributes.name']"
            >
            </step-custom-forms>
          </div>
          <div [class.hidden]="!customPlanAttributesForm.inputs().length">
            <h5>Custom plan attributes</h5>
            <step-description>
              Custom attributes applied to all plans and derived from the plan screenInput
            </step-description>
            <step-custom-forms
              #customPlanAttributesForm
              [(stModel)]="customPlanAttributes"
              stScreen="plan"
              [stExcludeFields]="['attributes.name']"
            >
            </step-custom-forms>
          </div>
          <step-label>Routing options</step-label>
          <step-description>
            The routing configuration will be propagated to all keywords in this Automation Package. For most cases the
            default setting shouldn't be changed. (<a
              target="_blank"
              href="https://step.dev/knowledgebase/devops/step-automation-package-ui/"
              >open documentation</a
            >)
          </step-description>
          <step-form-field>
            <mat-checkbox color="primary" #executeLocally="matCheckbox" formControlName="executeFunctionsLocally">
              <span>Execute on controller</span>
            </mat-checkbox>
          </step-form-field>
          @if (!executeLocally.checked) {
            <section class="criteria-header">
              <div>
                <label>Agent token selection criteria</label>
                <button type="button" mat-icon-button (click)="addRoutingCriterion()">
                  <step-icon name="plus"></step-icon>
                </button>
              </div>
            </section>
            <section class="criteria-body" formArrayName="routing">
              @for (group of routing.controls; track $index; let i = $index) {
                <div [formGroupName]="i" class="criterion-row">
                  <step-form-field>
                    <input type="text" placeholder="Key" formControlName="key" />
                  </step-form-field>
                  <step-form-field>
                    <input type="text" placeholder="Value" formControlName="value" />
                  </step-form-field>
                  <button type="button" mat-stroked-button (click)="routing.removeAt(i)">
                    <step-icon name="trash-2"></step-icon>
                  </button>
                </div>
              }
            </section>
          }
        }
      </form>
    }
  </div>
  <div step-modal-window-buttons [stepEntityRef]="_package">
    <button type="button" mat-stroked-button mat-dialog-close [disabled]="!!progress$">Cancel</button>
    <button
      type="button"
      mat-flat-button
      color="primary"
      (click)="upload()"
      [disabled]="!!progress$ || !(AutomationPackagePermission.WRITE | hasRight | async)"
    >
      @if (isAffectingOtherPackage) {
        Force&nbsp;
      }

      @if (!isNewPackage) {
        Update
      } @else {
        @switch (apType) {
          @case (UploadType.UPLOAD) {
            Upload
          }
          @case (UploadType.MAVEN) {
            Add
          }
          @default {}
        }
      }
    </button>
  </div>
</step-modal-window>
