<step-btn-group class="with-borders">
  <button
    *ngIf="hasUndo"
    type="button"
    mat-stroked-button
    [matTooltip]="captions.revertAll"
    matTooltipPosition="below"
    (click)="discardAll.emit()"
  >
    Discard All
  </button>

  <button
    type="button"
    mat-stroked-button
    [disabled]="!hasUndo"
    [matTooltip]="captions.undo"
    matTooltipPosition="below"
    (click)="undo.emit()"
  >
    <step-icon class="icon-flipped" name="rotate-cw" />
  </button>

  <button
    type="button"
    mat-stroked-button
    [disabled]="!hasRedo"
    [matTooltip]="captions.redo"
    matTooltipPosition="below"
    (click)="redo.emit()"
  >
    <step-icon name="rotate-cw" />
  </button>
  @for (editorAction of _planActions; track editorAction.id) {
    <step-dashlet [itemKey]="editorAction.template" [context]="planContext" />
  }
  <button
    type="button"
    mat-stroked-button
    (click)="clone.emit()"
    [matTooltip]="captions.duplicate"
    [disabled]="!('plan-write' | hasRight | async)"
    matTooltipPosition="below"
  >
    <step-icon name="copy" />
  </button>

  <button
    type="button"
    mat-stroked-button
    (click)="export.emit()"
    [matTooltip]="captions.export"
    matTooltipPosition="below"
  >
    <step-icon name="upload" />
  </button>
  @if (showExportSourceButton) {
    <button
      type="button"
      mat-stroked-button
      (click)="showSource.emit()"
      [matTooltip]="captions.showSource"
      matTooltipPosition="below"
    >
      <step-icon name="code" />
    </button>
  }
</step-btn-group>
<step-btn-group class="with-borders">
  <button
    type="button"
    mat-stroked-button
    [class.active]="isInteractiveSessionActive"
    (click)="toggleInteractiveSession()"
    [matTooltip]="isInteractiveSessionActive ? captions.stopInteractive : captions.startInteractive"
    [disabled]="!('plan-write' | hasRight | async)"
    matTooltipPosition="below"
  >
    <step-icon name="bug-01" />
  </button>

  @if (isInteractiveSessionActive) {
    <button
      type="button"
      mat-stroked-button
      (click)="reset.emit()"
      [matTooltip]="captions.resetInteractive"
      matTooltipPosition="below"
    >
      <step-icon name="refresh-cw" />
    </button>
  }
  <span class="interactive-trigger" #interactiveSessionTrigger [matMenuTriggerFor]="interactiveSessionMenu"></span>
</step-btn-group>

@if (_interactiveSession.hasExecutionParameters()) {
  <step-btn-group class="with-borders">
    <step-popover yPosition="above" [mode]="PopoverMode.HOVER">
      <button
        type="button"
        mat-stroked-button
        [class.active]="targetExecutionParameters && Object.keys(targetExecutionParameters).length > 0"
        (click)="toggleTargetParameterSelection()"
      >
        <step-icon name="sliders" />
      </button>
      <step-popover-content>
        Advanced: Set target execution parameters so the editor can display the right Keyword or Plan version (See
        <a
          href="https://step.dev/knowledgebase/devops/automation-packages-overview/#deploy-multiple-versions-of-the-same-automation-package"
          target="_blank"
          >Automation Packages: Versions</a
        >).
      </step-popover-content>
    </step-popover>
    <span
      class="interactive-trigger"
      #targetExecutionParameterTrigger
      [matMenuTriggerFor]="targetExecutionParameterMenu"
    ></span>
  </step-btn-group>
}

@if (showExecuteButton) {
  <step-btn-group class="with-borders">
    @for (editorAction of _planExecutionActions; track editorAction.id) {
      <step-dashlet [itemKey]="editorAction.template" [context]="planContext" />
    }
    <button
      type="button"
      mat-stroked-button
      color="primary"
      matTooltip="Execute this plan"
      matTooltipPosition="below"
      (click)="runPlan.emit()"
    >
      <step-icon name="play-circle" />
    </button>
  </step-btn-group>
}

<mat-menu #interactiveSessionMenu="matMenu" class="execution-menu">
  <span class="execution-menu" mat-menu-item [disableRipple]="true" (click)="$event.stopImmediatePropagation()">
    <div class="interactive-parameters">
      @if (_interactiveSession.hasExecutionParameters()) {
        <step-custom-forms
          #interactiveSessionCustomForm
          [stModel]="_interactiveSession.executionParameters()!"
          (stModelChange)="setInteractiveSessionExecutionParameters($event)"
          stScreen="executionParameters"
        />
      }
      <step-btn-group>
        <button
          type="button"
          mat-stroked-button
          (click)="startInteractiveSession()"
          [matTooltip]="captions.startInteractive"
          matTooltipPosition="below"
        >
          {{ captions.startInteractiveShort }}
        </button>
      </step-btn-group>
    </div>
  </span>
</mat-menu>

<mat-menu #targetExecutionParameterMenu="matMenu" class="execution-menu">
  <span class="execution-menu" mat-menu-item [disableRipple]="true" (click)="$event.stopImmediatePropagation()">
    <div class="interactive-parameters">
      @if (_interactiveSession.hasExecutionParameters()) {
        <step-custom-forms
          #interactiveSessionCustomForm
          [stModel]="targetExecutionParameters || {}"
          (stModelChange)="setTargetExecutionParameters($event)"
          stScreen="executionParameters"
        />
      }
    </div>
  </span>
</mat-menu>
