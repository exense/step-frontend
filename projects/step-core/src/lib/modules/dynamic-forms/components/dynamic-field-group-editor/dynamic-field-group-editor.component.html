<div widthExpanders key="dynamicFields">
  <ng-container [formGroup]="form">
    @if (primaryFieldsLabel) {
      <h5>{{ primaryFieldsLabel }}</h5>
    }
    @if (primaryFieldsDescription) {
      <p class="description">{{ primaryFieldsDescription }}</p>
    }
    @for (field of primaryFields; track field.trackId) {
      <step-dynamic-field
        [formControl]="field.control"
        [label]="field.label"
        [canEditLabel]="field.isAdditional"
        [fieldType]="field.fieldType"
        [fieldSchema]="field.fieldSchema"
        [canRemove]="false"
        [enumItems]="field.enumItems"
        [tooltip]="field.tooltip"
        elementRefMapKey="dynamicFields"
      />
    }

    @if (!!optionalFields?.length) {
      @if (optionalFieldsLabel) {
        <h5>{{ optionalFieldsLabel }}</h5>
      }
      @if (optionalFieldsDescription) {
        <p class="description">{{ optionalFieldsDescription }}</p>
      }
    }
    @for (field of optionalFields; track field.trackId) {
      <step-dynamic-field
        [formControl]="field.control"
        [label]="field.label"
        (labelChange)="updateLabel(field, $event)"
        [canEditLabel]="field.isAdditional"
        [fieldType]="field.fieldType"
        [fieldSchema]="field.fieldSchema"
        [canRemove]="true"
        [enumItems]="field.enumItems"
        [tooltip]="field.tooltip"
        (remove)="removeField(field)"
        elementRefMapKey="dynamicFields"
      />
    }
  </ng-container>
  @if (!isDisabled && (possibleFieldsToAdd.length > 0 || !schema?.properties || allowNotSchemaFields)) {
    <step-add-field-button
      [addLabel]="addFieldBtnLabel || ''"
      [possibleFields]="possibleFieldsToAdd"
      (addField)="addOptionalField($event)"
    />
  }
</div>
