<cdk-tree [dataSource]="dataSource" [treeControl]="treeControl" cdkDropList (cdkDropListDropped)="drop($event)">
  <cdk-tree-node
    *cdkTreeNodeDef="let node"
    cdkTreeNodePadding
    [cdkTreeNodePaddingIndent]="paddingIdent"
    class="tree-node"
    cdkDrag
    [cdkDragDisabled]="node.id === rootNode?.id || dragDisabled"
    [class.tree-node-selected]="node.id === selectedNodeId"
    (click)="selectNode(node)"
  >
    <button mat-button mat-icon-button disabled></button>
    <div class="node-content" (contextmenu)="openContextMenu($event, node.id)">
      <step-icon [name]="node._class | artefactIcon" cdkDragHandle class="drag-handle"></step-icon>
      {{ node?.name }}
    </div>
    <div class="drag-placeholder" *cdkDragPlaceholder></div>
  </cdk-tree-node>
  <cdk-tree-node
    *cdkTreeNodeDef="let node; when: hasChild"
    cdkTreeNodePadding
    [cdkTreeNodePaddingIndent]="paddingIdent"
    class="tree-node"
    [class.expanded]="treeControl.isExpanded(node)"
    cdkDrag
    [cdkDragDisabled]="node.id === rootNode?.id || dragDisabled"
    [class.tree-node-selected]="node.id === selectedNodeId"
    (click)="selectNode(node)"
  >
    <button mat-button mat-icon-button cdkTreeNodeToggle (click)="expansionModel.toggle(node.id)">
      <ng-template #expanded>
        <step-icon name="chevron-down"> </step-icon>
      </ng-template>
      <ng-template #notExpanded>
        <step-icon name="chevron-right"> </step-icon>
      </ng-template>
      <ng-container *ngIf="treeControl.isExpanded(node); then expanded; else notExpanded"> </ng-container>
    </button>
    <div class="node-content" (contextmenu)="openContextMenu($event, node.id)">
      <step-icon [name]="node._class | artefactIcon" cdkDragHandle class="drag-handle"></step-icon>
      {{ node?.name }}
    </div>
    <ng-container *cdkDragPreview>
      <step-icon [name]="node._class | artefactIcon"></step-icon>
      {{ node?.name }}
    </ng-container>
    <div class="drag-placeholder" *cdkDragPlaceholder></div>
  </cdk-tree-node>
</cdk-tree>
<div
  #nodeContextMenuTrigger
  class="node-context-menu-trigger"
  [style.left.px]="contextMenuPosition.x"
  [style.top.px]="contextMenuPosition.y"
  [matMenuTriggerFor]="nodeContextMenu"
></div>
<mat-menu #nodeContextMenu="matMenu">
  <ng-template matMenuContent let-node="node">
    <button
      *ngFor="let action of actions; trackBy: trackByAction"
      mat-menu-item
      [disabled]="action.disabled"
      (click)="handleContextAction(action, node)"
    >
      {{ action.label }}
    </button>
  </ng-template>
</mat-menu>
