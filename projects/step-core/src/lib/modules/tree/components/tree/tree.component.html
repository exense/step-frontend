<cdk-tree [dataSource]="_treeState.dataSource" [treeControl]="_treeState.treeControl" cdkDropListGroup>
  <ng-container>
    <cdk-tree-node
      *cdkTreeNodeDef="let node"
      cdkTreeNodePadding
      [cdkTreeNodePaddingIndent]="paddingIdent"
      [class.cdk-tree-node-selected]="node.id | isNodeSelected | async"
      cdkDropList
      cdkDropListSortingDisabled="true"
      [cdkDropListData]="node.id"
      (cdkDropListDropped)="_treeDragDrop.handleDrop()"
      (click)="_treeState.selectNode(node, $event)"
      (dblclick)="handleDblClick(node, $event)"
    >
      <div *ngFor="let level of node.level | arrayOfSize" [style.--level]="level" class="node-line"></div>
      <step-tree-node
        [style.padding-left.px]="node.level * paddingMultiplier"
        [class.context-menu-open]="node.id === openedMenuNodeId"
        [node]="node"
        [canToggle]="false"
        [treeContainer]="_treeContainer"
        [dragDisabled]="dragDisabled"
        (contextMenu)="openContextMenu($event)"
      >
      </step-tree-node>
    </cdk-tree-node>
  </ng-container>
  <ng-container>
    <cdk-tree-node
      *cdkTreeNodeDef="let node; when: hasChild"
      cdkTreeNodePadding
      [cdkTreeNodePaddingIndent]="paddingIdent"
      [class.cdk-tree-node-selected]="node.id | isNodeSelected | async"
      [class.expanded]="_treeState.treeControl.isExpanded(node)"
      cdkDropList
      cdkDropListSortingDisabled="true"
      (cdkDropListDropped)="_treeDragDrop.handleDrop()"
      [cdkDropListData]="node.id"
      (click)="_treeState.selectNode(node, $event)"
      (dblclick)="handleDblClick(node, $event)"
    >
      <div *ngFor="let level of node.level | arrayOfSize" [style.--level]="level" class="node-line"></div>
      <step-tree-node
        [style.padding-left.px]="node.level * paddingMultiplier"
        [class.context-menu-open]="node.id === openedMenuNodeId"
        [node]="node"
        [canToggle]="true"
        [treeContainer]="_treeContainer"
        [dragDisabled]="dragDisabled"
        (contextMenu)="openContextMenu($event)"
      >
      </step-tree-node>
    </cdk-tree-node>
  </ng-container>
</cdk-tree>
<div
  #nodeContextMenuTrigger
  class="node-context-menu-trigger"
  [style.left.px]="contextMenuPosition.x"
  [style.top.px]="contextMenuPosition.y"
  [matMenuTriggerFor]="nodeContextMenu"
  (menuClosed)="handleContextClose()"
></div>
<mat-menu #nodeContextMenu="matMenu">
  <ng-template matMenuContent let-node="node">
    <ng-container *ngFor="let action of node | treeNodeActions | async; trackBy: trackByAction">
      <button
        class="tree-action-item"
        mat-menu-item
        [disabled]="action.disabled"
        (click)="handleContextAction(action, node)"
      >
        {{ action.label }}
      </button>
      <mat-divider *ngIf="action.hasSeparator"></mat-divider>
    </ng-container>
  </ng-template>
</mat-menu>
