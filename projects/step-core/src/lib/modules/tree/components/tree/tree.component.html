<div cdkDropListGroup>
  <cdk-tree [dataSource]="_treeState.dataSource" [treeControl]="_treeState.treeControl">
    <ng-container>
      <cdk-tree-node
        *cdkTreeNodeDef="let node"
        [stepNodeElementRef]="node"
        cdkTreeNodePadding
        [cdkTreeNodePaddingIndent]="paddingIdent"
        [class.cdk-tree-node-selected]="node.id | isNodeSelected | async"
        cdkDropList
        cdkDropListSortingDisabled="true"
        [cdkDropListData]="node.id"
        (cdkDropListDropped)="_treeDragDrop.handleDrop()"
        (click)="_treeState.selectNode(node, $event)"
        (dblclick)="handleDblClick(node, $event)"
      >
        <div *ngFor="let level of node.level | arrayOfSize" [style.--level]="level" class="node-line"></div>
        <step-tree-node
          [style.padding-left.px]="node.level * paddingMultiplier"
          [node]="node"
          [canToggle]="false"
          [treeContainer]="_treeContainer"
          [dragDisabled]="dragDisabled"
          (contextMenu)="openContextMenu($event)"
        >
        </step-tree-node>
      </cdk-tree-node>
    </ng-container>
    <ng-container>
      <cdk-tree-node
        *cdkTreeNodeDef="let node; when: hasChild"
        [stepNodeElementRef]="node"
        cdkTreeNodePadding
        [cdkTreeNodePaddingIndent]="paddingIdent"
        [class.cdk-tree-node-selected]="node.id | isNodeSelected | async"
        [class.expanded]="_treeState.treeControl.isExpanded(node)"
        cdkDropList
        cdkDropListSortingDisabled="true"
        (cdkDropListDropped)="_treeDragDrop.handleDrop()"
        [cdkDropListData]="node.id"
        (click)="_treeState.selectNode(node, $event)"
        (dblclick)="handleDblClick(node, $event)"
      >
        <div *ngFor="let level of node.level | arrayOfSize" [style.--level]="level" class="node-line"></div>
        <step-tree-node
          [style.padding-left.px]="node.level * paddingMultiplier"
          [node]="node"
          [canToggle]="true"
          [treeContainer]="_treeContainer"
          [dragDisabled]="dragDisabled"
          (contextMenu)="openContextMenu($event)"
        >
        </step-tree-node>
      </cdk-tree-node>
    </ng-container>
  </cdk-tree>
  <step-tree-bottom *ngIf="!dragDisabled" [bottomInfo]="bottomInfo"> </step-tree-bottom>
</div>
<div
  #nodeContextMenuTrigger
  class="node-context-menu-trigger"
  [style.left.px]="contextMenuPosition.x"
  [style.top.px]="contextMenuPosition.y"
  [matMenuTriggerFor]="nodeContextMenu"
></div>
<mat-menu #nodeContextMenu="matMenu">
  <ng-template matMenuContent let-node="node">
    <button
      *ngFor="let action of node | treeNodeActions | async; trackBy: trackByAction"
      mat-menu-item
      [disabled]="action.disabled"
      (click)="handleContextAction(action, node)"
    >
      {{ action.label }}
    </button>
  </ng-template>
</mat-menu>
