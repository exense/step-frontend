<ng-template #dynamicSwitchTemplate>
  <step-suffix class="button-suffix" *ngIf="withDynamicSwitch">
    <button
      type="button"
      mat-stroked-button
      matTooltip="Use a dynamic expression to set this attribute"
      (click)="dynamicSwitch.emit()"
    >
      <step-icon name="zap"></step-icon>
    </button>
  </step-suffix>
</ng-template>

<step-upload-container (filesChange)="onFilesChange($event)">
  <ng-container *ngIf="!isResource; else resourceTemplate">
    <step-form-field>
      <step-label *ngIf="label" [attr.show-required-marker]="showRequiredMarker || null">
        <span>{{ label }}</span>

        <step-icon *ngIf="withHelpIcon" name="help-circle" [matTooltip]="helpIconTooltip || ''"></step-icon>
      </step-label>

      <input
        type="text"
        [required]="!!showRequiredMarker"
        [ngModel]="stModel"
        (ngModelChange)="onStModelChange($event)"
        [readonly]="disableServerPath"
        [matTooltip]="
          disableServerPath
            ? 'Drag and drop your file here'
            : 'Drag and drop your file here or enter the path to a file accessible from the controller'
        "
        (blur)="onBlur()"
      />

      <step-suffix class="button-suffix" *ngIf="withSaveButton">
        <button type="button" mat-stroked-button [disabled]="stModel === lastStModelValue" (click)="saveChanges()">
          {{ saveButtonLabel }}
        </button>
      </step-suffix>
      <step-suffix class="button-suffix">
        <button
          type="button"
          mat-stroked-button
          matTooltip="Select an existing resource"
          [disabled]="uploadOnly"
          (click)="selectResource()"
        >
          <step-icon name="search"></step-icon>
        </button>
      </step-suffix>
      <step-suffix class="button-suffix">
        <button type="button" mat-stroked-button matTooltip="Select from file system" (click)="openFileChooser()">
          <step-icon name="folder-plus"></step-icon>
        </button>
      </step-suffix>
      <ng-container matSuffix>
        <ng-container *ngTemplateOutlet="dynamicSwitchTemplate"></ng-container>
      </ng-container>
    </step-form-field>
  </ng-container>

  <ng-template #resourceTemplate>
    <ng-container *ngIf="!resourceNotExisting">
      <step-form-field>
        <step-label *ngIf="label" [attr.show-required-marker]="showRequiredMarker || null">
          <span>{{ label }}</span>

          <step-icon *ngIf="withHelpIcon" name="help-circle" [matTooltip]="helpIconTooltip || ''"></step-icon>
        </step-label>

        <input
          type="text"
          [required]="!!showRequiredMarker"
          readonly="readonly"
          [ngModel]="resourceFilename"
          matTooltip="Drag and drop your file here or enter the path to a file accessible from the controller"
        />

        <step-suffix class="button-suffix">
          <a [href]="downloadResourceUrl" mat-stroked-button matTooltip="Download this file">
            <step-icon name="download"></step-icon>
          </a>
        </step-suffix>
        <step-suffix class="button-suffix">
          <button type="button" mat-stroked-button matTooltip="Select from file system" (click)="openFileChooser()">
            <step-icon name="folder-plus"></step-icon>
          </button>
        </step-suffix>
        <step-suffix class="button-suffix">
          <button
            type="button"
            mat-stroked-button
            matTooltip="Select an existing resource"
            [disabled]="uploadOnly"
            (click)="selectResource()"
          >
            <step-icon name="search"></step-icon>
          </button>
        </step-suffix>
        <step-suffix class="button-suffix">
          <button type="button" mat-stroked-button matTooltip="Clear" (click)="clear()">
            <step-icon name="x"></step-icon>
          </button>
        </step-suffix>
        <ng-container *ngTemplateOutlet="dynamicSwitchTemplate"></ng-container>
      </step-form-field>
    </ng-container>

    <ng-container *ngIf="resourceNotExisting">
      <step-form-field>
        <step-label *ngIf="label" [attr.show-required-marker]="showRequiredMarker || null">
          <span>{{ label }}</span>

          <step-icon *ngIf="withHelpIcon" name="help-circle" [matTooltip]="helpIconTooltip || ''"></step-icon>
        </step-label>

        <input
          type="text"
          [required]="!!showRequiredMarker"
          readonly="readonly"
          value="Error: the referenced resource doesn't exist anymore."
          matTooltip="Drag and drop your file here or enter the path to a file accessible from the controller"
        />

        <step-suffix class="button-suffix">
          <button type="button" mat-stroked-button matTooltip="Clear" (click)="clear()">
            <step-icon name="x"></step-icon>
          </button>
        </step-suffix>
        <ng-container *ngTemplateOutlet="dynamicSwitchTemplate"></ng-container>
      </step-form-field>
    </ng-container>
  </ng-template>
</step-upload-container>

<input #fileInput type="file" (input)="onChooseFile()" />

<step-progress-bar *ngIf="progress$" [progress$]="progress$"></step-progress-bar>
